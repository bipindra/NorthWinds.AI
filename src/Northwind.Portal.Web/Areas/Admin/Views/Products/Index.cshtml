@model Northwind.Portal.Domain.DTOs.PagedResult<Northwind.Portal.Domain.DTOs.ProductDto>
@{
    ViewData["Title"] = "Products";
}

<div class="card shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-box me-2"></i>Products</h5>
        <div>
            <a asp-action="Reindex" class="btn btn-info btn-sm me-2">
                <i class="fas fa-sync-alt me-1"></i>Reindex to Vector DB
            </a>
            <a asp-action="Import" class="btn btn-success btn-sm me-2">
                <i class="fas fa-file-csv me-1"></i>Import from CSV
            </a>
            <a asp-action="Create" class="btn btn-primary btn-sm">
                <i class="fas fa-plus me-1"></i>Add New Product
            </a>
        </div>
    </div>
    <div class="card-body">
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>@TempData["Success"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>@TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <form method="get" class="row g-3 mb-4">
            <div class="col-md-4">
                <input type="text" name="searchTerm" class="form-control" placeholder="Search products..." value="@ViewBag.SearchTerm" />
            </div>
            <div class="col-md-3">
                <select name="categoryId" class="form-select">
                    <option value="">All Categories</option>
                    @foreach (var category in ViewBag.Categories as IEnumerable<Northwind.Portal.Domain.DTOs.CategoryDto> ?? Enumerable.Empty<Northwind.Portal.Domain.DTOs.CategoryDto>())
                    {
                        <option value="@category.CategoryId" selected="@(ViewBag.CategoryId != null && (int)ViewBag.CategoryId == category.CategoryId)">@category.CategoryName</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <select name="supplierId" class="form-select">
                    <option value="">All Suppliers</option>
                    @foreach (var supplier in ViewBag.Suppliers as IEnumerable<Northwind.Portal.Domain.DTOs.SupplierDto> ?? Enumerable.Empty<Northwind.Portal.Domain.DTOs.SupplierDto>())
                    {
                        <option value="@supplier.SupplierId" selected="@(ViewBag.SupplierId != null && (int)ViewBag.SupplierId == supplier.SupplierId)">@supplier.CompanyName</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <select name="discontinued" class="form-select">
                    <option value="">All Products</option>
                    <option value="false" selected="@(ViewBag.Discontinued == false)">Active</option>
                    <option value="true" selected="@(ViewBag.Discontinued == true)">Discontinued</option>
                </select>
            </div>
            <div class="col-md-3">
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" name="inStockOnly" value="true" id="inStockOnly" checked="@ViewBag.InStockOnly" />
                    <label class="form-check-label" for="inStockOnly">In Stock Only</label>
                </div>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-search me-1"></i>Filter
                </button>
            </div>
            <div class="col-md-2">
                <a asp-action="Index" class="btn btn-outline-secondary w-100">
                    <i class="fas fa-times me-1"></i>Clear
                </a>
            </div>
        </form>

        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Product Name</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Supplier</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Status</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Items.Any())
                    {
                        @foreach (var product in Model.Items)
                        {
                            <tr>
                                <td>@product.ProductId</td>
                                <td>
                                    <strong>@product.ProductName</strong>
                                    @if (!string.IsNullOrEmpty(product.QuantityPerUnit))
                                    {
                                        <br /><small class="text-muted">@product.QuantityPerUnit</small>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(product.Description))
                                    {
                                        <span class="text-truncate d-inline-block" style="max-width: 200px;" title="@product.Description">
                                            @(product.Description.Length > 50 ? product.Description.Substring(0, 50) + "..." : product.Description)
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>@(product.CategoryName ?? "-")</td>
                                <td>@(product.SupplierName ?? "-")</td>
                                <td>
                                    @if (product.UnitPrice.HasValue)
                                    {
                                        <strong>$@product.UnitPrice.Value.ToString("F2")</strong>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>
                                    @if (product.UnitsInStock.HasValue)
                                    {
                                        <span class="badge @(product.UnitsInStock.Value > 0 ? "bg-success" : "bg-danger")">
                                            @product.UnitsInStock.Value
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>
                                    @if (product.Discontinued)
                                    {
                                        <span class="badge bg-danger">Discontinued</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">Active</span>
                                    }
                                </td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a asp-action="Details" asp-route-id="@product.ProductId" class="btn btn-outline-info" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a asp-action="Edit" asp-route-id="@product.ProductId" class="btn btn-outline-primary" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="9" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                                No products found
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (Model.TotalCount > 0)
        {
            <nav aria-label="Products pagination">
                <ul class="pagination justify-content-center mb-0">
                    @{
                        var totalPages = (int)Math.Ceiling((double)Model.TotalCount / Model.PageSize);
                        var currentPage = Model.Page;
                        var showEllipsis = totalPages > 10;
                        var startPage = Math.Max(1, currentPage - 2);
                        var endPage = Math.Min(totalPages, currentPage + 2);
                    }

                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <a class="page-link" asp-action="Index" asp-route-page="@(currentPage - 1)" asp-route-categoryId="@ViewBag.CategoryId" asp-route-supplierId="@ViewBag.SupplierId" asp-route-discontinued="@ViewBag.Discontinued" asp-route-inStockOnly="@ViewBag.InStockOnly" asp-route-searchTerm="@ViewBag.SearchTerm" aria-label="Previous">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>

                    @* First Page *@
                    @if (showEllipsis && startPage > 1)
                    {
                        <li class="page-item @(1 == currentPage ? "active" : "")">
                            <a class="page-link" asp-action="Index" asp-route-page="1" asp-route-categoryId="@ViewBag.CategoryId" asp-route-supplierId="@ViewBag.SupplierId" asp-route-discontinued="@ViewBag.Discontinued" asp-route-inStockOnly="@ViewBag.InStockOnly" asp-route-searchTerm="@ViewBag.SearchTerm">1</a>
                        </li>
                        @if (startPage > 2)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                    }

                    @* Pages around current *@
                    @for (int i = startPage; i <= endPage; i++)
                    {
                        <li class="page-item @(i == currentPage ? "active" : "")">
                            <a class="page-link" asp-action="Index" asp-route-page="@i" asp-route-categoryId="@ViewBag.CategoryId" asp-route-supplierId="@ViewBag.SupplierId" asp-route-discontinued="@ViewBag.Discontinued" asp-route-inStockOnly="@ViewBag.InStockOnly" asp-route-searchTerm="@ViewBag.SearchTerm">@i</a>
                        </li>
                    }

                    @* Last Page *@
                    @if (showEllipsis && endPage < totalPages)
                    {
                        @if (endPage < totalPages - 1)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                        <li class="page-item @(totalPages == currentPage ? "active" : "")">
                            <a class="page-link" asp-action="Index" asp-route-page="@totalPages" asp-route-categoryId="@ViewBag.CategoryId" asp-route-supplierId="@ViewBag.SupplierId" asp-route-discontinued="@ViewBag.Discontinued" asp-route-inStockOnly="@ViewBag.InStockOnly" asp-route-searchTerm="@ViewBag.SearchTerm">@totalPages</a>
                        </li>
                    }

                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                        <a class="page-link" asp-action="Index" asp-route-page="@(currentPage + 1)" asp-route-categoryId="@ViewBag.CategoryId" asp-route-supplierId="@ViewBag.SupplierId" asp-route-discontinued="@ViewBag.Discontinued" asp-route-inStockOnly="@ViewBag.InStockOnly" asp-route-searchTerm="@ViewBag.SearchTerm" aria-label="Next">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="text-center text-muted mt-2">
                Showing @((Model.Page - 1) * Model.PageSize + 1) to @(Math.Min(Model.Page * Model.PageSize, Model.TotalCount)) of @Model.TotalCount products
            </div>
        }
    </div>
</div>
