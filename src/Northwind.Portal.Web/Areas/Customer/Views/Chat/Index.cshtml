@{
    ViewData["Title"] = "AI Chat Assistant";
}

<div class="card shadow-sm">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="fas fa-comments me-2"></i>AI Chat Assistant</h5>
    </div>
    <div class="card-body">
        <div id="chatContainer" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: auto; background-color: #f8f9fa;">
            <div id="chatMessages">
                <div class="chat-message bot-message mb-2 p-2 rounded" style="background-color: #e3f2fd;">
                    <strong>Assistant:</strong> Hello! I'm your AI assistant. How can I help you with your Northwind Portal today?
                </div>
            </div>
        </div>

        <form id="chatForm">
            @Html.AntiForgeryToken()
            <div class="input-group">
                <input type="text" id="messageInput" class="form-control" placeholder="Type your message here..." autocomplete="off" />
                <button type="submit" class="btn btn-primary" id="sendButton">
                    <i class="fas fa-paper-plane me-1"></i>Send
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            const chatForm = $('#chatForm');
            const messageInput = $('#messageInput');
            const chatMessages = $('#chatMessages');
            const chatContainer = $('#chatContainer');
            const sendButton = $('#sendButton');

            chatForm.on('submit', async function(e) {
                e.preventDefault();
                
                const message = messageInput.val().trim();
                if (!message) return;

                // Disable input while processing
                messageInput.prop('disabled', true);
                sendButton.prop('disabled', true);

                // Add user message to chat
                addMessage('You', message, 'user-message');
                messageInput.val('');

                // Show typing indicator
                const typingId = addMessage('Assistant', 'Typing...', 'bot-message typing');

                try {
                    const token = $('input[name="__RequestVerificationToken"]').val();
                    const response = await fetch('@Url.Action("SendMessage", "Chat")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token
                        },
                        body: JSON.stringify({ message: message })
                    });

                    const data = await response.json();

                    // Remove typing indicator
                    $(`#${typingId}`).remove();

                    if (data.success) {
                        addMessage('Assistant', data.message, 'bot-message');
                        
                        // Handle actions (e.g., product added to cart)
                        if (data.actions && data.actions.length > 0) {
                            data.actions.forEach(action => {
                                if (action.type === 'product_added') {
                                    // Show a notification or update UI
                                    showNotification('Product added to cart!', 'success');
                                }
                            });
                        }
                    } else {
                        addMessage('Assistant', data.message || 'Sorry, I encountered an error.', 'bot-message error');
                    }
                } catch (error) {
                    $(`#${typingId}`).remove();
                    addMessage('Assistant', 'Sorry, I encountered an error. Please try again.', 'bot-message error');
                    console.error('Error:', error);
                } finally {
                    // Re-enable input
                    messageInput.prop('disabled', false);
                    sendButton.prop('disabled', false);
                    messageInput.focus();
                }
            });

            function addMessage(sender, message, className) {
                const messageId = 'msg-' + Date.now();
                const isUser = className.includes('user-message');
                const bgColor = isUser ? '#c8e6c9' : '#e3f2fd';
                const margin = isUser ? 'ms-auto' : '';
                // Replace newlines with <br> for proper display
                const formattedMessage = escapeHtml(message).replace(/\n/g, '<br>');
                const messageHtml = `
                    <div id="${messageId}" class="chat-message ${className} mb-2 p-2 rounded ${margin}" style="background-color: ${bgColor}; ${isUser ? 'max-width: 80%;' : ''}">
                        <strong>${sender}:</strong> ${formattedMessage}
                    </div>
                `;
                chatMessages.append(messageHtml);
                
                // Scroll to bottom
                chatContainer.scrollTop(chatContainer[0].scrollHeight);
                
                return messageId;
            }

            function escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            function showNotification(message, type) {
                // Create a temporary notification
                const notification = $(`
                    <div class="alert alert-${type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed" 
                         style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                        <strong>${message}</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `);
                $('body').append(notification);
                
                // Auto-dismiss after 3 seconds
                setTimeout(() => {
                    notification.fadeOut(() => notification.remove());
                }, 3000);
            }

            // Focus input on load
            messageInput.focus();
        });
    </script>

    <style>
        .chat-message {
            word-wrap: break-word;
        }
        .chat-message.typing {
            font-style: italic;
            color: #666;
        }
        .chat-message.error {
            background-color: #ffebee !important;
            color: #c62828;
        }
    </style>
}
