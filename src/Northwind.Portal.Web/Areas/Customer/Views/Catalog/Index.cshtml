@model Northwind.Portal.Domain.DTOs.PagedResult<Northwind.Portal.Domain.DTOs.ProductDto>
@{
    ViewData["Title"] = "Product Catalog";
}

<div class="card shadow-sm">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="fas fa-store me-2"></i>Products</h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3 mb-4">
            <div class="col-md-5">
                <input type="text" name="searchTerm" class="form-control" placeholder="Search products..." value="@ViewBag.SearchTerm" />
            </div>
            <div class="col-md-4">
                <select name="categoryId" class="form-select">
                    <option value="">All Categories</option>
                    @foreach (var category in ViewBag.Categories as IEnumerable<Northwind.Portal.Domain.DTOs.CategoryDto> ?? Enumerable.Empty<Northwind.Portal.Domain.DTOs.CategoryDto>())
                    {
                        <option value="@category.CategoryId" selected="@(ViewBag.CategoryId != null && (int)ViewBag.CategoryId == category.CategoryId)">@category.CategoryName</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-search me-1"></i>Filter
                </button>
            </div>
        </form>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Product Name</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Items != null && Model.Items.Any())
                    {
                        @foreach (var product in Model.Items)
                        {
                            <tr>
                                <td><strong>@product.ProductName</strong></td>
                                <td>@product.CategoryName</td>
                                <td>@product.UnitPrice?.ToString("C")</td>
                                <td>
                                    @if (product.UnitsInStock > 0)
                                    {
                                        <span class="badge bg-success">@product.UnitsInStock in stock</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">Out of stock</span>
                                    }
                                </td>
                                <td>
                                    <a asp-action="Details" asp-route-id="@product.ProductId" class="btn btn-sm btn-primary me-1">
                                        <i class="fas fa-eye me-1"></i>View
                                    </a>
                                    <form asp-controller="Cart" asp-action="Add" method="post" style="display:inline;">
                                        <input type="hidden" name="productId" value="@product.ProductId" />
                                        <input type="hidden" name="quantity" value="1" />
                                        <button type="submit" class="btn btn-sm btn-success">
                                            <i class="fas fa-cart-plus me-1"></i>Add to Cart
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                                No products found
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        
        @if (Model.TotalPages > 1)
        {
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    @{
                        var currentPage = Model.Page;
                        var totalPages = Model.TotalPages;
                        var showEllipsis = totalPages > 10;
                        var startPage = Math.Max(1, currentPage - 2);
                        var endPage = Math.Min(totalPages, currentPage + 2);
                    }
                    
                    @* Previous Button *@
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <a class="page-link" href="?page=@(currentPage - 1)&searchTerm=@ViewBag.SearchTerm&categoryId=@ViewBag.CategoryId" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    
                    @* First Page *@
                    @if (showEllipsis && startPage > 1)
                    {
                        <li class="page-item @(1 == currentPage ? "active" : "")">
                            <a class="page-link" href="?page=1&searchTerm=@ViewBag.SearchTerm&categoryId=@ViewBag.CategoryId">1</a>
                        </li>
                        @if (startPage > 2)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                    }
                    
                    @* Pages around current *@
                    @for (int i = startPage; i <= endPage; i++)
                    {
                        <li class="page-item @(i == currentPage ? "active" : "")">
                            <a class="page-link" href="?page=@i&searchTerm=@ViewBag.SearchTerm&categoryId=@ViewBag.CategoryId">@i</a>
                        </li>
                    }
                    
                    @* Last Page *@
                    @if (showEllipsis && endPage < totalPages)
                    {
                        @if (endPage < totalPages - 1)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                        <li class="page-item @(totalPages == currentPage ? "active" : "")">
                            <a class="page-link" href="?page=@totalPages&searchTerm=@ViewBag.SearchTerm&categoryId=@ViewBag.CategoryId">@totalPages</a>
                        </li>
                    }
                    
                    @* Next Button *@
                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                        <a class="page-link" href="?page=@(currentPage + 1)&searchTerm=@ViewBag.SearchTerm&categoryId=@ViewBag.CategoryId" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
        }
    </div>
</div>
