<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Customer Portal</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <style>
        /* Customer-specific styles */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            background-color: #f8fafc !important;
            color: #1e293b !important;
            margin: 0;
            padding: 0;
        }
        .wrapper {
            display: flex !important;
            min-height: 100vh !important;
        }
        .sidebar {
            width: 260px !important;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%) !important;
            color: #fff !important;
            position: fixed !important;
            height: 100vh !important;
            left: 0 !important;
            top: 0 !important;
            z-index: 1000 !important;
        }
        .main-content {
            flex: 1 !important;
            margin-left: 260px !important;
            display: flex !important;
            flex-direction: column !important;
            min-height: 100vh !important;
        }
        .top-navbar {
            background: #ffffff !important;
            border-bottom: 1px solid #e2e8f0 !important;
            padding: 1rem 2rem !important;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05) !important;
            position: sticky !important;
            top: 0 !important;
            z-index: 999 !important;
        }
        .content {
            flex: 1 !important;
            background: #f8fafc !important;
            padding: 1.5rem !important;
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Customer Sidebar -->
        @await Html.PartialAsync("_Sidebar")
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Navbar -->
            @await Html.PartialAsync("_TopNavbar")
            
            <!-- Page Content -->
            <main class="content">
                <div class="container-fluid py-4">
                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            @TempData["Success"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            @TempData["Error"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }
                    
                    @if (!string.IsNullOrEmpty(ViewData["Title"]?.ToString()))
                    {
                        <div class="page-header mb-4">
                            <h1 class="page-title">@ViewData["Title"]</h1>
                        </div>
                    }
                    
                    @RenderBody()
                </div>
            </main>
            
            <!-- Footer -->
            <footer class="footer">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-6">
                            <span class="text-muted">© @DateTime.Now.Year Northwind Customer Portal. All rights reserved.</span>
                        </div>
                        <div class="col-md-6 text-end">
                            <span class="text-muted">Version 1.0</span>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Floating AI Chat Widget -->
    <div id="chatWidget" class="chat-widget" style="display: none;">
        <div class="chat-widget-header">
            <div class="d-flex align-items-center">
                <i class="fas fa-comments me-2"></i>
                <strong>AI Assistant</strong>
            </div>
            <button type="button" class="btn btn-link btn-sm p-0 text-white" id="chatWidgetMinimize">
                <i class="fas fa-minus"></i>
            </button>
        </div>
        <div class="chat-widget-body" id="chatWidgetBody">
            <div id="chatMessages" class="chat-messages">
                <div class="chat-message bot-message">
                    <strong>Assistant:</strong> Hello! I'm your AI assistant. How can I help you with your Northwind Portal today?
                </div>
            </div>
        </div>
        <div class="chat-widget-footer">
            <form id="chatWidgetForm">
                @Html.AntiForgeryToken()
                <div class="input-group">
                    <input type="text" id="chatWidgetInput" class="form-control form-control-sm" placeholder="Type your message..." autocomplete="off" />
                    <button type="submit" class="btn btn-primary btn-sm" id="chatWidgetSend">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Chat Widget Toggle Button (Fixed Bottom Right) -->
    <button type="button" class="btn btn-primary chat-widget-toggle" id="chatWidgetToggle" title="Open AI Chat">
        <i class="fas fa-comments"></i>
        <span class="chat-widget-badge" id="chatWidgetBadge" style="display: none;">1</span>
    </button>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <!-- jQuery Validation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation/1.19.5/jquery.validate.min.js" integrity="sha512-rstIgDs0xPgmG6RX1Aba4KV5cWJbAMcvRCVmglpam9SoHZiUCyQVDdH2LPlxoHtrv17XWblm/V/PP+Tr04hbtA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js" integrity="sha512-o6XqxgrUsKmchwy9G5VRNWSSxTS4UqIKNupyvKycFWPR9c0GvjvU2FwN6l+Q8uZ3z8g8K8d3NcF7RbjZAzZ3A==" crossorigin="anonymous"></script>
    <!-- Custom JS -->
    <script src="~/js/site.js" asp-append-version="true"></script>
    
    <script>
        // Auto-dismiss alerts after 5 seconds
        $(document).ready(function() {
            setTimeout(function() {
                $('.alert').fadeOut('slow');
            }, 5000);
            
            // Sidebar toggle for mobile
            $('#sidebarToggle').on('click', function() {
                $('body').toggleClass('sidebar-collapsed');
            });
            
            // Update cart count periodically
            function updateCartCount() {
                $.get('@Url.Action("GetCount", "Cart", new { area = "Customer" })')
                    .done(function(data) {
                        var count = data.count || 0;
                        var badge = $('#cartIconLink .cart-badge');
                        
                        if (count > 0) {
                            if (badge.length === 0) {
                                $('#cartIconLink').append(
                                    '<span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger cart-badge">' + count + '</span>'
                                );
                            } else {
                                badge.text(count);
                            }
                        } else {
                            badge.remove();
                        }
                    })
                    .fail(function() {
                        // Silently fail
                    });
            }
            
            // Update cart count on page load
            updateCartCount();
            
            // Update cart count every 10 seconds
            setInterval(updateCartCount, 10000);
            
            // Update cart count when navigating (for SPA-like behavior)
            $(document).on('click', 'a[href*="Cart/Add"], form[action*="Cart/Add"]', function() {
                setTimeout(updateCartCount, 500);
            });

            // Chat Widget Functionality
            const chatWidget = $('#chatWidget');
            const chatWidgetToggle = $('#chatWidgetToggle');
            const chatWidgetMinimize = $('#chatWidgetMinimize');
            const chatWidgetForm = $('#chatWidgetForm');
            const chatWidgetInput = $('#chatWidgetInput');
            const chatWidgetBody = $('#chatWidgetBody');
            const chatMessages = $('#chatMessages');
            let isChatMinimized = false;

            // Function to toggle chat widget
            function toggleChatWidget() {
                if (chatWidget.is(':visible') && !chatWidget.hasClass('minimized')) {
                    chatWidget.fadeOut();
                } else {
                    chatWidget.removeClass('minimized');
                    chatWidget.fadeIn();
                    chatWidgetInput.focus();
                }
            }

            // Chat Icon Button (in navbar) - trigger chat widget
            $('#chatIconBtn').on('click', function(e) {
                e.preventDefault();
                toggleChatWidget();
            });

            chatWidgetToggle.on('click', function() {
                if (chatWidget.is(':visible')) {
                    chatWidget.fadeOut();
                } else {
                    chatWidget.fadeIn();
                    chatWidgetInput.focus();
                }
            });

            chatWidgetMinimize.on('click', function() {
                chatWidget.toggleClass('minimized');
                isChatMinimized = !isChatMinimized;
                if (!isChatMinimized) {
                    chatWidgetInput.focus();
                }
            });

            chatWidgetForm.on('submit', async function(e) {
                e.preventDefault();
                
                const message = chatWidgetInput.val().trim();
                if (!message) return;

                chatWidgetInput.prop('disabled', true);
                $('#chatWidgetSend').prop('disabled', true);

                addChatMessage('You', message, 'user-message');
                chatWidgetInput.val('');

                const typingId = addChatMessage('Assistant', 'Typing...', 'bot-message typing');

                try {
                    const token = $('input[name="__RequestVerificationToken"]').val();
                    const response = await fetch('@Url.Action("SendMessage", "Chat", new { area = "Customer" })', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token
                        },
                        body: JSON.stringify({ message: message })
                    });

                    const data = await response.json();
                    $(`#${typingId}`).remove();

                    if (data.success) {
                        addChatMessage('Assistant', data.message, 'bot-message');
                        
                        if (data.actions && data.actions.length > 0) {
                            data.actions.forEach(action => {
                                if (action.type === 'product_added' && action.data) {
                                    const productName = action.data.productName || 'Product';
                                    const description = action.data.description || '';
                                    showProductToast(productName, description);
                                    updateCartCount();
                                }
                            });
                        }
                    } else {
                        addChatMessage('Assistant', data.message || 'Sorry, I encountered an error.', 'bot-message error');
                    }
                } catch (error) {
                    $(`#${typingId}`).remove();
                    addChatMessage('Assistant', 'Sorry, I encountered an error. Please try again.', 'bot-message error');
                    console.error('Error:', error);
                } finally {
                    chatWidgetInput.prop('disabled', false);
                    $('#chatWidgetSend').prop('disabled', false);
                    chatWidgetInput.focus();
                }
            });

            function addChatMessage(sender, message, className) {
                const messageId = 'chat-msg-' + Date.now();
                const isUser = className.includes('user-message');
                const formattedMessage = escapeHtml(message).replace(/\n/g, '<br>');
                const messageHtml = `
                    <div id="${messageId}" class="chat-message ${className}">
                        <strong>${sender}:</strong> ${formattedMessage}
                    </div>
                `;
                chatMessages.append(messageHtml);
                chatWidgetBody.scrollTop(chatWidgetBody[0].scrollHeight);
                return messageId;
            }

            function escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            function showProductToast(productName, description) {
                const toast = $(`
                    <div class="toast-notification success">
                        <div class="toast-notification-header">
                            <i class="fas fa-check-circle me-2"></i>Product Added to Cart
                        </div>
                        <div class="toast-notification-body">
                            <strong>${escapeHtml(productName)}</strong>
                            ${description ? '<br><small>' + escapeHtml(description) + '</small>' : ''}
                        </div>
                    </div>
                `);
                
                if ($('.toast-container').length === 0) {
                    $('body').append('<div class="toast-container"></div>');
                }
                
                $('.toast-container').append(toast);
                
                setTimeout(() => {
                    toast.fadeOut(() => toast.remove());
                }, 5000);
            }

            // Cart Hover Popup
            const cartIconContainer = $('#cartIconContainer');
            const cartPopup = $('#cartPopup');
            let cartHoverTimeout;

            cartIconContainer.on('mouseenter', function() {
                clearTimeout(cartHoverTimeout);
                loadCartPopup();
                cartPopup.fadeIn(200);
            });

            cartIconContainer.on('mouseleave', function() {
                cartHoverTimeout = setTimeout(() => {
                    cartPopup.fadeOut(200);
                }, 300);
            });

            cartPopup.on('mouseenter', function() {
                clearTimeout(cartHoverTimeout);
            });

            cartPopup.on('mouseleave', function() {
                cartPopup.fadeOut(200);
            });

            async function loadCartPopup() {
                try {
                    const response = await fetch('@Url.Action("GetDetails", "Cart", new { area = "Customer" })');
                    const data = await response.json();
                    const popupBody = $('#cartPopupBody');
                    
                    if (data.lines && data.lines.length > 0) {
                        let html = '';
                        data.lines.forEach(line => {
                            html += `
                                <div class="cart-popup-item">
                                    <div class="cart-popup-item-info">
                                        <div class="cart-popup-item-name">${escapeHtml(line.productName)}</div>
                                        ${line.description ? `<div class="cart-popup-item-desc">${escapeHtml(line.description)}</div>` : ''}
                                        <div class="cart-popup-item-details">
                                            Qty: ${line.quantity} × $${line.unitPrice.toFixed(2)}
                                        </div>
                                    </div>
                                    <div class="cart-popup-item-price">
                                        $${line.lineTotal.toFixed(2)}
                                    </div>
                                </div>
                            `;
                        });
                        html += `
                            <div class="cart-popup-footer">
                                <div class="d-flex justify-content-between mb-2">
                                    <strong>Subtotal:</strong>
                                    <strong>$${data.subTotal.toFixed(2)}</strong>
                                </div>
                            </div>
                        `;
                        popupBody.html(html);
                    } else {
                        popupBody.html('<div class="cart-popup-empty"><i class="fas fa-shopping-cart fa-2x mb-2"></i><div>Your cart is empty</div></div>');
                    }
                } catch (error) {
                    console.error('Error loading cart popup:', error);
                    $('#cartPopupBody').html('<div class="cart-popup-empty text-danger">Error loading cart</div>');
                }
            }
        });
    </script>
    
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
